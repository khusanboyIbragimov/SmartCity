"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _memoizeOne = _interopRequireDefault(require("memoize-one"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireDefault(require("react"));

var _simpleUpdateIn = _interopRequireDefault(require("simple-update-in"));

var _EventSpy = _interopRequireDefault(require("../EventSpy"));

var _FunctionContext = _interopRequireDefault(require("./FunctionContext"));

var _InternalContext = _interopRequireDefault(require("./InternalContext"));

var _SpineTo = _interopRequireDefault(require("../SpineTo"));

var _StateContext = _interopRequireDefault(require("./StateContext"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

var Composer =
/*#__PURE__*/
function (_React$Component) {
  _inherits(Composer, _React$Component);

  function Composer(props) {
    var _this;

    _classCallCheck(this, Composer);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(Composer).call(this, props));
    _this.createStateContext = (0, _memoizeOne.default)(function (stateContext, scrollTop) {
      return _objectSpread({}, stateContext, {
        animating: scrollTop || scrollTop === 0
      });
    });
    _this.handleScroll = _this.handleScroll.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.handleScrollEnd = _this.handleScrollEnd.bind(_assertThisInitialized(_assertThisInitialized(_this)));
    _this.state = {
      functionContext: {
        scrollTo: function scrollTo(scrollTop) {
          return _this.setState(function () {
            return {
              scrollTop: scrollTop
            };
          });
        },
        scrollToBottom: function scrollToBottom() {
          return _this.state.functionContext.scrollTo('bottom');
        },
        scrollToEnd: function scrollToEnd() {
          var _assertThisInitialize = _assertThisInitialized(_assertThisInitialized(_this)),
              state = _assertThisInitialize.state;

          state.stateContext.mode === 'top' ? state.functionContext.scrollToTop() : state.functionContext.scrollToBottom();
        },
        scrollToStart: function scrollToStart() {
          var _assertThisInitialize2 = _assertThisInitialized(_assertThisInitialized(_this)),
              state = _assertThisInitialize2.state;

          state.stateContext.mode === 'top' ? state.functionContext.scrollToBottom() : state.functionContext.scrollToTop();
        },
        scrollToTop: function scrollToTop() {
          return _this.state.functionContext.scrollTo(0);
        }
      },
      internalContext: {
        _handleUpdate: function _handleUpdate() {
          var _assertThisInitialize3 = _assertThisInitialized(_assertThisInitialized(_this)),
              state = _assertThisInitialize3.state;

          state.stateContext.atEnd && state.functionContext.scrollToEnd();
        },
        _setTarget: function _setTarget(target) {
          return _this.setState(function () {
            return {
              target: target
            };
          });
        }
      },
      scrollTop: null,
      stateContext: {
        animating: false,
        atBottom: true,
        atEnd: true,
        atTop: true,
        mode: props.mode,
        threshold: 10
      },
      target: null
    };
    return _this;
  }

  _createClass(Composer, [{
    key: "componentWillReceiveProps",
    value: function componentWillReceiveProps(nextProps) {
      this.setState(function (_ref) {
        var stateContext = _ref.stateContext;
        return {
          stateContext: _objectSpread({}, stateContext, {
            mode: nextProps.mode === 'top' ? 'top' : 'bottom',
            threshold: nextProps.threshold
          })
        };
      });
    }
  }, {
    key: "handleScroll",
    value: function handleScroll() {
      this.setState(function (_ref2) {
        var stateContext = _ref2.stateContext,
            target = _ref2.target;

        if (target) {
          var mode = stateContext.mode,
              threshold = stateContext.threshold;
          var offsetHeight = target.offsetHeight,
              scrollHeight = target.scrollHeight,
              scrollTop = target.scrollTop;
          var atBottom = scrollHeight - scrollTop - offsetHeight <= threshold;
          var atTop = scrollTop <= threshold;
          var nextStateContext;
          nextStateContext = (0, _simpleUpdateIn.default)(stateContext, ['atBottom'], function () {
            return atBottom;
          });
          nextStateContext = (0, _simpleUpdateIn.default)(nextStateContext, ['atEnd'], function () {
            return mode === 'top' ? atTop : atBottom;
          });
          nextStateContext = (0, _simpleUpdateIn.default)(nextStateContext, ['atStart'], function () {
            return mode === 'top' ? atBottom : atTop;
          });
          nextStateContext = (0, _simpleUpdateIn.default)(nextStateContext, ['atTop'], function () {
            return atTop;
          });

          if (stateContext !== nextStateContext) {
            return {
              stateContext: nextStateContext
            };
          }
        }
      });
    }
  }, {
    key: "handleScrollEnd",
    value: function handleScrollEnd() {
      this.setState(function () {
        return {
          scrollTop: null
        };
      });
    }
  }, {
    key: "render",
    value: function render() {
      var createStateContext = this.createStateContext,
          handleScroll = this.handleScroll,
          handleScrollEnd = this.handleScrollEnd,
          _this$props = this.props,
          children = _this$props.children,
          debounce = _this$props.debounce,
          _this$state = this.state,
          functionContext = _this$state.functionContext,
          internalContext = _this$state.internalContext,
          scrollTop = _this$state.scrollTop,
          stateContext = _this$state.stateContext,
          target = _this$state.target;
      return _react.default.createElement(_InternalContext.default.Provider, {
        value: internalContext
      }, _react.default.createElement(_FunctionContext.default.Provider, {
        value: functionContext
      }, _react.default.createElement(_StateContext.default.Provider, {
        value: createStateContext(stateContext, scrollTop)
      }, children, target && _react.default.createElement(_EventSpy.default, {
        debounce: debounce,
        name: "scroll",
        onEvent: handleScroll,
        target: target
      }), target && (scrollTop || scrollTop === 0) && _react.default.createElement(_SpineTo.default, {
        name: "scrollTop",
        onEnd: handleScrollEnd,
        target: target,
        value: scrollTop
      }))));
    }
  }]);

  return Composer;
}(_react.default.Component);

exports.default = Composer;
Composer.defaultProps = {
  debounce: 17,
  threshold: 10
};
Composer.propTypes = {
  debounce: _propTypes.default.number,
  threshold: _propTypes.default.number
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TY3JvbGxUb0JvdHRvbS9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJDb21wb3NlciIsInByb3BzIiwiY3JlYXRlU3RhdGVDb250ZXh0Iiwic3RhdGVDb250ZXh0Iiwic2Nyb2xsVG9wIiwiYW5pbWF0aW5nIiwiaGFuZGxlU2Nyb2xsIiwiYmluZCIsImhhbmRsZVNjcm9sbEVuZCIsInN0YXRlIiwiZnVuY3Rpb25Db250ZXh0Iiwic2Nyb2xsVG8iLCJzZXRTdGF0ZSIsInNjcm9sbFRvQm90dG9tIiwic2Nyb2xsVG9FbmQiLCJtb2RlIiwic2Nyb2xsVG9Ub3AiLCJzY3JvbGxUb1N0YXJ0IiwiaW50ZXJuYWxDb250ZXh0IiwiX2hhbmRsZVVwZGF0ZSIsImF0RW5kIiwiX3NldFRhcmdldCIsInRhcmdldCIsImF0Qm90dG9tIiwiYXRUb3AiLCJ0aHJlc2hvbGQiLCJuZXh0UHJvcHMiLCJvZmZzZXRIZWlnaHQiLCJzY3JvbGxIZWlnaHQiLCJuZXh0U3RhdGVDb250ZXh0IiwiY2hpbGRyZW4iLCJkZWJvdW5jZSIsIlJlYWN0IiwiQ29tcG9uZW50IiwiZGVmYXVsdFByb3BzIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwibnVtYmVyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBRXFCQSxROzs7OztBQUNuQixvQkFBWUMsS0FBWixFQUFtQjtBQUFBOztBQUFBOztBQUNqQixrRkFBTUEsS0FBTjtBQUVBLFVBQUtDLGtCQUFMLEdBQTBCLHlCQUFRLFVBQUNDLFlBQUQsRUFBZUMsU0FBZjtBQUFBLCtCQUM3QkQsWUFENkI7QUFFaENFLFFBQUFBLFNBQVMsRUFBRUQsU0FBUyxJQUFJQSxTQUFTLEtBQUs7QUFGTjtBQUFBLEtBQVIsQ0FBMUI7QUFLQSxVQUFLRSxZQUFMLEdBQW9CLE1BQUtBLFlBQUwsQ0FBa0JDLElBQWxCLHVEQUFwQjtBQUNBLFVBQUtDLGVBQUwsR0FBdUIsTUFBS0EsZUFBTCxDQUFxQkQsSUFBckIsdURBQXZCO0FBRUEsVUFBS0UsS0FBTCxHQUFhO0FBQ1hDLE1BQUFBLGVBQWUsRUFBRTtBQUNmQyxRQUFBQSxRQUFRLEVBQUUsa0JBQUFQLFNBQVM7QUFBQSxpQkFBSSxNQUFLUSxRQUFMLENBQWM7QUFBQSxtQkFBTztBQUFFUixjQUFBQSxTQUFTLEVBQVRBO0FBQUYsYUFBUDtBQUFBLFdBQWQsQ0FBSjtBQUFBLFNBREo7QUFFZlMsUUFBQUEsY0FBYyxFQUFFO0FBQUEsaUJBQU0sTUFBS0osS0FBTCxDQUFXQyxlQUFYLENBQTJCQyxRQUEzQixDQUFvQyxRQUFwQyxDQUFOO0FBQUEsU0FGRDtBQUdmRyxRQUFBQSxXQUFXLEVBQUUsdUJBQU07QUFBQTtBQUFBLGNBQ1RMLEtBRFMseUJBQ1RBLEtBRFM7O0FBR2pCQSxVQUFBQSxLQUFLLENBQUNOLFlBQU4sQ0FBbUJZLElBQW5CLEtBQTRCLEtBQTVCLEdBQW9DTixLQUFLLENBQUNDLGVBQU4sQ0FBc0JNLFdBQXRCLEVBQXBDLEdBQTBFUCxLQUFLLENBQUNDLGVBQU4sQ0FBc0JHLGNBQXRCLEVBQTFFO0FBQ0QsU0FQYztBQVFmSSxRQUFBQSxhQUFhLEVBQUUseUJBQU07QUFBQTtBQUFBLGNBQ1hSLEtBRFcsMEJBQ1hBLEtBRFc7O0FBR25CQSxVQUFBQSxLQUFLLENBQUNOLFlBQU4sQ0FBbUJZLElBQW5CLEtBQTRCLEtBQTVCLEdBQW9DTixLQUFLLENBQUNDLGVBQU4sQ0FBc0JHLGNBQXRCLEVBQXBDLEdBQTZFSixLQUFLLENBQUNDLGVBQU4sQ0FBc0JNLFdBQXRCLEVBQTdFO0FBQ0QsU0FaYztBQWFmQSxRQUFBQSxXQUFXLEVBQUU7QUFBQSxpQkFBTSxNQUFLUCxLQUFMLENBQVdDLGVBQVgsQ0FBMkJDLFFBQTNCLENBQW9DLENBQXBDLENBQU47QUFBQTtBQWJFLE9BRE47QUFnQlhPLE1BQUFBLGVBQWUsRUFBRTtBQUNmQyxRQUFBQSxhQUFhLEVBQUUseUJBQU07QUFBQTtBQUFBLGNBQ1hWLEtBRFcsMEJBQ1hBLEtBRFc7O0FBR25CQSxVQUFBQSxLQUFLLENBQUNOLFlBQU4sQ0FBbUJpQixLQUFuQixJQUE0QlgsS0FBSyxDQUFDQyxlQUFOLENBQXNCSSxXQUF0QixFQUE1QjtBQUNELFNBTGM7QUFNZk8sUUFBQUEsVUFBVSxFQUFFLG9CQUFBQyxNQUFNO0FBQUEsaUJBQUksTUFBS1YsUUFBTCxDQUFjO0FBQUEsbUJBQU87QUFBRVUsY0FBQUEsTUFBTSxFQUFOQTtBQUFGLGFBQVA7QUFBQSxXQUFkLENBQUo7QUFBQTtBQU5ILE9BaEJOO0FBd0JYbEIsTUFBQUEsU0FBUyxFQUFFLElBeEJBO0FBeUJYRCxNQUFBQSxZQUFZLEVBQUU7QUFDWkUsUUFBQUEsU0FBUyxFQUFFLEtBREM7QUFFWmtCLFFBQUFBLFFBQVEsRUFBRSxJQUZFO0FBR1pILFFBQUFBLEtBQUssRUFBRSxJQUhLO0FBSVpJLFFBQUFBLEtBQUssRUFBRSxJQUpLO0FBS1pULFFBQUFBLElBQUksRUFBRWQsS0FBSyxDQUFDYyxJQUxBO0FBTVpVLFFBQUFBLFNBQVMsRUFBRTtBQU5DLE9BekJIO0FBaUNYSCxNQUFBQSxNQUFNLEVBQUU7QUFqQ0csS0FBYjtBQVhpQjtBQThDbEI7Ozs7OENBRXlCSSxTLEVBQVc7QUFDbkMsV0FBS2QsUUFBTCxDQUFjO0FBQUEsWUFBR1QsWUFBSCxRQUFHQSxZQUFIO0FBQUEsZUFBdUI7QUFDbkNBLFVBQUFBLFlBQVksb0JBQ1BBLFlBRE87QUFFVlksWUFBQUEsSUFBSSxFQUFFVyxTQUFTLENBQUNYLElBQVYsS0FBbUIsS0FBbkIsR0FBMkIsS0FBM0IsR0FBbUMsUUFGL0I7QUFHVlUsWUFBQUEsU0FBUyxFQUFFQyxTQUFTLENBQUNEO0FBSFg7QUFEdUIsU0FBdkI7QUFBQSxPQUFkO0FBT0Q7OzttQ0FFYztBQUNiLFdBQUtiLFFBQUwsQ0FBYyxpQkFBOEI7QUFBQSxZQUEzQlQsWUFBMkIsU0FBM0JBLFlBQTJCO0FBQUEsWUFBYm1CLE1BQWEsU0FBYkEsTUFBYTs7QUFDMUMsWUFBSUEsTUFBSixFQUFZO0FBQUEsY0FDRlAsSUFERSxHQUNrQlosWUFEbEIsQ0FDRlksSUFERTtBQUFBLGNBQ0lVLFNBREosR0FDa0J0QixZQURsQixDQUNJc0IsU0FESjtBQUFBLGNBRUZFLFlBRkUsR0FFd0NMLE1BRnhDLENBRUZLLFlBRkU7QUFBQSxjQUVZQyxZQUZaLEdBRXdDTixNQUZ4QyxDQUVZTSxZQUZaO0FBQUEsY0FFMEJ4QixTQUYxQixHQUV3Q2tCLE1BRnhDLENBRTBCbEIsU0FGMUI7QUFHVixjQUFNbUIsUUFBUSxHQUFHSyxZQUFZLEdBQUd4QixTQUFmLEdBQTJCdUIsWUFBM0IsSUFBMkNGLFNBQTVEO0FBQ0EsY0FBTUQsS0FBSyxHQUFHcEIsU0FBUyxJQUFJcUIsU0FBM0I7QUFFQSxjQUFJSSxnQkFBSjtBQUVBQSxVQUFBQSxnQkFBZ0IsR0FBRyw2QkFBUzFCLFlBQVQsRUFBdUIsQ0FBQyxVQUFELENBQXZCLEVBQXFDO0FBQUEsbUJBQU1vQixRQUFOO0FBQUEsV0FBckMsQ0FBbkI7QUFDQU0sVUFBQUEsZ0JBQWdCLEdBQUcsNkJBQVNBLGdCQUFULEVBQTJCLENBQUMsT0FBRCxDQUEzQixFQUFzQztBQUFBLG1CQUFNZCxJQUFJLEtBQUssS0FBVCxHQUFpQlMsS0FBakIsR0FBeUJELFFBQS9CO0FBQUEsV0FBdEMsQ0FBbkI7QUFDQU0sVUFBQUEsZ0JBQWdCLEdBQUcsNkJBQVNBLGdCQUFULEVBQTJCLENBQUMsU0FBRCxDQUEzQixFQUF3QztBQUFBLG1CQUFNZCxJQUFJLEtBQUssS0FBVCxHQUFpQlEsUUFBakIsR0FBNEJDLEtBQWxDO0FBQUEsV0FBeEMsQ0FBbkI7QUFDQUssVUFBQUEsZ0JBQWdCLEdBQUcsNkJBQVNBLGdCQUFULEVBQTJCLENBQUMsT0FBRCxDQUEzQixFQUFzQztBQUFBLG1CQUFNTCxLQUFOO0FBQUEsV0FBdEMsQ0FBbkI7O0FBRUEsY0FBSXJCLFlBQVksS0FBSzBCLGdCQUFyQixFQUF1QztBQUNyQyxtQkFBTztBQUFFMUIsY0FBQUEsWUFBWSxFQUFFMEI7QUFBaEIsYUFBUDtBQUNEO0FBQ0Y7QUFDRixPQWxCRDtBQW1CRDs7O3NDQUVpQjtBQUNoQixXQUFLakIsUUFBTCxDQUFjO0FBQUEsZUFBTztBQUFFUixVQUFBQSxTQUFTLEVBQUU7QUFBYixTQUFQO0FBQUEsT0FBZDtBQUNEOzs7NkJBRVE7QUFBQSxVQUVMRixrQkFGSyxHQU9ILElBUEcsQ0FFTEEsa0JBRks7QUFBQSxVQUdMSSxZQUhLLEdBT0gsSUFQRyxDQUdMQSxZQUhLO0FBQUEsVUFJTEUsZUFKSyxHQU9ILElBUEcsQ0FJTEEsZUFKSztBQUFBLHdCQU9ILElBUEcsQ0FLTFAsS0FMSztBQUFBLFVBS0k2QixRQUxKLGVBS0lBLFFBTEo7QUFBQSxVQUtjQyxRQUxkLGVBS2NBLFFBTGQ7QUFBQSx3QkFPSCxJQVBHLENBTUx0QixLQU5LO0FBQUEsVUFNSUMsZUFOSixlQU1JQSxlQU5KO0FBQUEsVUFNcUJRLGVBTnJCLGVBTXFCQSxlQU5yQjtBQUFBLFVBTXNDZCxTQU50QyxlQU1zQ0EsU0FOdEM7QUFBQSxVQU1pREQsWUFOakQsZUFNaURBLFlBTmpEO0FBQUEsVUFNK0RtQixNQU4vRCxlQU0rREEsTUFOL0Q7QUFTUCxhQUNFLDZCQUFDLHdCQUFELENBQWlCLFFBQWpCO0FBQTBCLFFBQUEsS0FBSyxFQUFHSjtBQUFsQyxTQUNFLDZCQUFDLHdCQUFELENBQWlCLFFBQWpCO0FBQTBCLFFBQUEsS0FBSyxFQUFHUjtBQUFsQyxTQUNFLDZCQUFDLHFCQUFELENBQWMsUUFBZDtBQUF1QixRQUFBLEtBQUssRUFBR1Isa0JBQWtCLENBQUNDLFlBQUQsRUFBZUMsU0FBZjtBQUFqRCxTQUNJMEIsUUFESixFQUdJUixNQUFNLElBQ0osNkJBQUMsaUJBQUQ7QUFDRSxRQUFBLFFBQVEsRUFBR1MsUUFEYjtBQUVFLFFBQUEsSUFBSSxFQUFDLFFBRlA7QUFHRSxRQUFBLE9BQU8sRUFBR3pCLFlBSFo7QUFJRSxRQUFBLE1BQU0sRUFBR2dCO0FBSlgsUUFKTixFQVlJQSxNQUFNLEtBQUtsQixTQUFTLElBQUlBLFNBQVMsS0FBSyxDQUFoQyxDQUFOLElBQ0UsNkJBQUMsZ0JBQUQ7QUFDRSxRQUFBLElBQUksRUFBQyxXQURQO0FBRUUsUUFBQSxLQUFLLEVBQUdJLGVBRlY7QUFHRSxRQUFBLE1BQU0sRUFBR2MsTUFIWDtBQUlFLFFBQUEsS0FBSyxFQUFHbEI7QUFKVixRQWJOLENBREYsQ0FERixDQURGO0FBMkJEOzs7O0VBekhtQzRCLGVBQU1DLFM7OztBQTRINUNqQyxRQUFRLENBQUNrQyxZQUFULEdBQXdCO0FBQ3RCSCxFQUFBQSxRQUFRLEVBQUUsRUFEWTtBQUV0Qk4sRUFBQUEsU0FBUyxFQUFFO0FBRlcsQ0FBeEI7QUFLQXpCLFFBQVEsQ0FBQ21DLFNBQVQsR0FBcUI7QUFDbkJKLEVBQUFBLFFBQVEsRUFBRUssbUJBQVVDLE1BREQ7QUFFbkJaLEVBQUFBLFNBQVMsRUFBRVcsbUJBQVVDO0FBRkYsQ0FBckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbWVtb2l6ZSBmcm9tICdtZW1vaXplLW9uZSc7XG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB1cGRhdGVJbiBmcm9tICdzaW1wbGUtdXBkYXRlLWluJztcblxuaW1wb3J0IEV2ZW50U3B5IGZyb20gJy4uL0V2ZW50U3B5JztcbmltcG9ydCBGdW5jdGlvbkNvbnRleHQgZnJvbSAnLi9GdW5jdGlvbkNvbnRleHQnO1xuaW1wb3J0IEludGVybmFsQ29udGV4dCBmcm9tICcuL0ludGVybmFsQ29udGV4dCc7XG5pbXBvcnQgU3BpbmVUbyBmcm9tICcuLi9TcGluZVRvJztcbmltcG9ydCBTdGF0ZUNvbnRleHQgZnJvbSAnLi9TdGF0ZUNvbnRleHQnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21wb3NlciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgc3VwZXIocHJvcHMpO1xuXG4gICAgdGhpcy5jcmVhdGVTdGF0ZUNvbnRleHQgPSBtZW1vaXplKChzdGF0ZUNvbnRleHQsIHNjcm9sbFRvcCkgPT4gKHtcbiAgICAgIC4uLnN0YXRlQ29udGV4dCxcbiAgICAgIGFuaW1hdGluZzogc2Nyb2xsVG9wIHx8IHNjcm9sbFRvcCA9PT0gMFxuICAgIH0pKTtcblxuICAgIHRoaXMuaGFuZGxlU2Nyb2xsID0gdGhpcy5oYW5kbGVTY3JvbGwuYmluZCh0aGlzKTtcbiAgICB0aGlzLmhhbmRsZVNjcm9sbEVuZCA9IHRoaXMuaGFuZGxlU2Nyb2xsRW5kLmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgZnVuY3Rpb25Db250ZXh0OiB7XG4gICAgICAgIHNjcm9sbFRvOiBzY3JvbGxUb3AgPT4gdGhpcy5zZXRTdGF0ZSgoKSA9PiAoeyBzY3JvbGxUb3AgfSkpLFxuICAgICAgICBzY3JvbGxUb0JvdHRvbTogKCkgPT4gdGhpcy5zdGF0ZS5mdW5jdGlvbkNvbnRleHQuc2Nyb2xsVG8oJ2JvdHRvbScpLFxuICAgICAgICBzY3JvbGxUb0VuZDogKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgc3RhdGUgfSA9IHRoaXM7XG5cbiAgICAgICAgICBzdGF0ZS5zdGF0ZUNvbnRleHQubW9kZSA9PT0gJ3RvcCcgPyBzdGF0ZS5mdW5jdGlvbkNvbnRleHQuc2Nyb2xsVG9Ub3AoKSA6IHN0YXRlLmZ1bmN0aW9uQ29udGV4dC5zY3JvbGxUb0JvdHRvbSgpO1xuICAgICAgICB9LFxuICAgICAgICBzY3JvbGxUb1N0YXJ0OiAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBzdGF0ZSB9ID0gdGhpcztcblxuICAgICAgICAgIHN0YXRlLnN0YXRlQ29udGV4dC5tb2RlID09PSAndG9wJyA/IHN0YXRlLmZ1bmN0aW9uQ29udGV4dC5zY3JvbGxUb0JvdHRvbSgpIDogc3RhdGUuZnVuY3Rpb25Db250ZXh0LnNjcm9sbFRvVG9wKCk7XG4gICAgICAgIH0sXG4gICAgICAgIHNjcm9sbFRvVG9wOiAoKSA9PiB0aGlzLnN0YXRlLmZ1bmN0aW9uQ29udGV4dC5zY3JvbGxUbygwKVxuICAgICAgfSxcbiAgICAgIGludGVybmFsQ29udGV4dDoge1xuICAgICAgICBfaGFuZGxlVXBkYXRlOiAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBzdGF0ZSB9ID0gdGhpcztcblxuICAgICAgICAgIHN0YXRlLnN0YXRlQ29udGV4dC5hdEVuZCAmJiBzdGF0ZS5mdW5jdGlvbkNvbnRleHQuc2Nyb2xsVG9FbmQoKTtcbiAgICAgICAgfSxcbiAgICAgICAgX3NldFRhcmdldDogdGFyZ2V0ID0+IHRoaXMuc2V0U3RhdGUoKCkgPT4gKHsgdGFyZ2V0IH0pKVxuICAgICAgfSxcbiAgICAgIHNjcm9sbFRvcDogbnVsbCxcbiAgICAgIHN0YXRlQ29udGV4dDoge1xuICAgICAgICBhbmltYXRpbmc6IGZhbHNlLFxuICAgICAgICBhdEJvdHRvbTogdHJ1ZSxcbiAgICAgICAgYXRFbmQ6IHRydWUsXG4gICAgICAgIGF0VG9wOiB0cnVlLFxuICAgICAgICBtb2RlOiBwcm9wcy5tb2RlLFxuICAgICAgICB0aHJlc2hvbGQ6IDEwXG4gICAgICB9LFxuICAgICAgdGFyZ2V0OiBudWxsXG4gICAgfTtcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7XG4gICAgdGhpcy5zZXRTdGF0ZSgoeyBzdGF0ZUNvbnRleHQgfSkgPT4gKHtcbiAgICAgIHN0YXRlQ29udGV4dDoge1xuICAgICAgICAuLi5zdGF0ZUNvbnRleHQsXG4gICAgICAgIG1vZGU6IG5leHRQcm9wcy5tb2RlID09PSAndG9wJyA/ICd0b3AnIDogJ2JvdHRvbScsXG4gICAgICAgIHRocmVzaG9sZDogbmV4dFByb3BzLnRocmVzaG9sZFxuICAgICAgfVxuICAgIH0pKTtcbiAgfVxuXG4gIGhhbmRsZVNjcm9sbCgpIHtcbiAgICB0aGlzLnNldFN0YXRlKCh7IHN0YXRlQ29udGV4dCwgdGFyZ2V0IH0pID0+IHtcbiAgICAgIGlmICh0YXJnZXQpIHtcbiAgICAgICAgY29uc3QgeyBtb2RlLCB0aHJlc2hvbGQgfSA9IHN0YXRlQ29udGV4dDtcbiAgICAgICAgY29uc3QgeyBvZmZzZXRIZWlnaHQsIHNjcm9sbEhlaWdodCwgc2Nyb2xsVG9wIH0gPSB0YXJnZXQ7XG4gICAgICAgIGNvbnN0IGF0Qm90dG9tID0gc2Nyb2xsSGVpZ2h0IC0gc2Nyb2xsVG9wIC0gb2Zmc2V0SGVpZ2h0IDw9IHRocmVzaG9sZDtcbiAgICAgICAgY29uc3QgYXRUb3AgPSBzY3JvbGxUb3AgPD0gdGhyZXNob2xkO1xuXG4gICAgICAgIGxldCBuZXh0U3RhdGVDb250ZXh0O1xuXG4gICAgICAgIG5leHRTdGF0ZUNvbnRleHQgPSB1cGRhdGVJbihzdGF0ZUNvbnRleHQsIFsnYXRCb3R0b20nXSwgKCkgPT4gYXRCb3R0b20pO1xuICAgICAgICBuZXh0U3RhdGVDb250ZXh0ID0gdXBkYXRlSW4obmV4dFN0YXRlQ29udGV4dCwgWydhdEVuZCddLCAoKSA9PiBtb2RlID09PSAndG9wJyA/IGF0VG9wIDogYXRCb3R0b20pO1xuICAgICAgICBuZXh0U3RhdGVDb250ZXh0ID0gdXBkYXRlSW4obmV4dFN0YXRlQ29udGV4dCwgWydhdFN0YXJ0J10sICgpID0+IG1vZGUgPT09ICd0b3AnID8gYXRCb3R0b20gOiBhdFRvcCk7XG4gICAgICAgIG5leHRTdGF0ZUNvbnRleHQgPSB1cGRhdGVJbihuZXh0U3RhdGVDb250ZXh0LCBbJ2F0VG9wJ10sICgpID0+IGF0VG9wKTtcblxuICAgICAgICBpZiAoc3RhdGVDb250ZXh0ICE9PSBuZXh0U3RhdGVDb250ZXh0KSB7XG4gICAgICAgICAgcmV0dXJuIHsgc3RhdGVDb250ZXh0OiBuZXh0U3RhdGVDb250ZXh0IH07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZVNjcm9sbEVuZCgpIHtcbiAgICB0aGlzLnNldFN0YXRlKCgpID0+ICh7IHNjcm9sbFRvcDogbnVsbCB9KSk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY3JlYXRlU3RhdGVDb250ZXh0LFxuICAgICAgaGFuZGxlU2Nyb2xsLFxuICAgICAgaGFuZGxlU2Nyb2xsRW5kLFxuICAgICAgcHJvcHM6IHsgY2hpbGRyZW4sIGRlYm91bmNlIH0sXG4gICAgICBzdGF0ZTogeyBmdW5jdGlvbkNvbnRleHQsIGludGVybmFsQ29udGV4dCwgc2Nyb2xsVG9wLCBzdGF0ZUNvbnRleHQsIHRhcmdldCB9XG4gICAgfSA9IHRoaXM7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEludGVybmFsQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17IGludGVybmFsQ29udGV4dCB9PlxuICAgICAgICA8RnVuY3Rpb25Db250ZXh0LlByb3ZpZGVyIHZhbHVlPXsgZnVuY3Rpb25Db250ZXh0IH0+XG4gICAgICAgICAgPFN0YXRlQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17IGNyZWF0ZVN0YXRlQ29udGV4dChzdGF0ZUNvbnRleHQsIHNjcm9sbFRvcCkgfT5cbiAgICAgICAgICAgIHsgY2hpbGRyZW4gfVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICB0YXJnZXQgJiZcbiAgICAgICAgICAgICAgICA8RXZlbnRTcHlcbiAgICAgICAgICAgICAgICAgIGRlYm91bmNlPXsgZGVib3VuY2UgfVxuICAgICAgICAgICAgICAgICAgbmFtZT1cInNjcm9sbFwiXG4gICAgICAgICAgICAgICAgICBvbkV2ZW50PXsgaGFuZGxlU2Nyb2xsIH1cbiAgICAgICAgICAgICAgICAgIHRhcmdldD17IHRhcmdldCB9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgdGFyZ2V0ICYmIChzY3JvbGxUb3AgfHwgc2Nyb2xsVG9wID09PSAwKSAmJlxuICAgICAgICAgICAgICAgIDxTcGluZVRvXG4gICAgICAgICAgICAgICAgICBuYW1lPVwic2Nyb2xsVG9wXCJcbiAgICAgICAgICAgICAgICAgIG9uRW5kPXsgaGFuZGxlU2Nyb2xsRW5kIH1cbiAgICAgICAgICAgICAgICAgIHRhcmdldD17IHRhcmdldCB9XG4gICAgICAgICAgICAgICAgICB2YWx1ZT17IHNjcm9sbFRvcCB9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICA8L1N0YXRlQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgPC9GdW5jdGlvbkNvbnRleHQuUHJvdmlkZXI+XG4gICAgICA8L0ludGVybmFsQ29udGV4dC5Qcm92aWRlcj5cbiAgICApO1xuICB9XG59XG5cbkNvbXBvc2VyLmRlZmF1bHRQcm9wcyA9IHtcbiAgZGVib3VuY2U6IDE3LFxuICB0aHJlc2hvbGQ6IDEwXG59O1xuXG5Db21wb3Nlci5wcm9wVHlwZXMgPSB7XG4gIGRlYm91bmNlOiBQcm9wVHlwZXMubnVtYmVyLFxuICB0aHJlc2hvbGQ6IFByb3BUeXBlcy5udW1iZXJcbn07XG4iXX0=